# Database Migrations - Component Information

> **Last Updated**: 2025-12-31 12:51:00
> **Maintainer**: LLM Agent

---

## Folder Purpose
Contains Alembic database migration scripts for version control of the database schema. Manages schema creation, updates, and rollbacks.

---

## Component Table

| File Name | Purpose | Status |
|-----------|---------|--------|
| env.py | Alembic environment configuration | Complete |
| script.py.mako | Migration file template | Complete |
| versions/001_initial_schema.py | Initial schema migration (all 13 tables) | Complete |
| versions/002_seed_data.py | Seed data migration (admin user + templates) | Complete |

---

## Recent Changes

### [2025-12-31 12:51:00] - Alembic Migration System Implemented
**Changed By**: LLM Agent
**Reason**: Complete Phase 2.2 - Set up Alembic for database migrations
**Impact**: Production-ready database migration system with version control
**Files Modified**:
- Created migrations/env.py
- Created migrations/script.py.mako
- Created migrations/versions/001_initial_schema.py
- Created migrations/versions/002_seed_data.py
- Created migrations/INFO.md (this file)
**Feature IDs Affected**: N/A (Database infrastructure)
**Breaking Changes**: No

---

## Dependencies

- **Migration Tool**: Alembic 1.13.1+
- **ORM**: SQLAlchemy 2.0+
- **Database**: PostgreSQL 13+
- **Python**: 3.11+

---

## Migration Files

### env.py
Alembic environment configuration that:
- Imports all models from backend.models
- Sets target_metadata to Base.metadata for autogenerate
- Overrides database URL from DATABASE_URL environment variable
- Implements offline and online migration modes

### script.py.mako
Template for generating new migration files with:
- Standard upgrade() and downgrade() functions
- Proper imports for Alembic and SQLAlchemy
- Revision management (revision, down_revision, branch_labels, depends_on)

### 001_initial_schema.py
Initial schema migration that creates:
- All 13 tables (users, accounts, clusters, instances, node_templates, cluster_policies, hibernation_schedules, audit_logs, ml_models, optimization_jobs, lab_experiments, agent_actions, api_keys)
- All 12 enums (userrole, accountstatus, clusterstatus, instancelifecycle, templatestrategy, disktype, resourcetype, auditoutcome, mlmodelstatus, optimizationjobstatus, agentactiontype, agentactionstatus)
- All indexes (15+ indexes for query performance)
- All constraints (foreign keys, unique constraints, check constraints)
- Implements clean downgrade() to drop everything

### 002_seed_data.py
Seed data migration that creates:
- Default super admin user (admin@spotoptimizer.com / admin123)
- 4 default node templates (General Purpose, Compute Optimized, Memory Optimized, ARM-Based)
- Implements downgrade() to remove seed data

---

## Usage

### Apply Migrations
```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific migration
alembic upgrade <revision>

# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade <revision>

# Rollback all migrations
alembic downgrade base
```

### Create New Migration
```bash
# Autogenerate migration from model changes
alembic revision --autogenerate -m "description"

# Create empty migration
alembic revision -m "description"
```

### Check Status
```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads
```

---

## Migration Best Practices

1. **Always review autogenerated migrations** - Alembic may miss some changes
2. **Test rollback** - Every migration should have a working downgrade()
3. **One change per migration** - Keep migrations focused and atomic
4. **Add data migrations separately** - Schema and data migrations should be separate
5. **Use transactions** - Migrations run in transactions by default
6. **Version control** - Commit migrations to git immediately
7. **Production safety** - Test migrations on staging before production

---

## Testing Requirements

- Test upgrade() on clean database
- Test downgrade() after upgrade()
- Test idempotency (running twice should be safe)
- Test with production-like data volumes
- Verify all indexes are created
- Verify all foreign keys work correctly
