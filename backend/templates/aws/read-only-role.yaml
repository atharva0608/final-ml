AWSTemplateFormatVersion: '2010-09-09'
Description: 'Spot Optimizer: Read-Only Access for Cost Discovery'

Parameters:
  ExternalId:
    Type: String
    Description: 'Unique External ID for this account connection (Generated by Spot Optimizer)'
    MinLength: 36
    MaxLength: 36

  TrustedRoleARN:
    Type: String
    Description: 'ARN of the Spot Optimizer Backend Role'
    Default: 'arn:aws:iam::123456789012:role/SpotOptimizerBackendRole' # TO BE REPLACED WITH REAL ARN

Resources:
  SpotOptimizerRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub 'SpotOptimizer-Access-Role-${AWS::Region}' 
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Ref TrustedRoleARN
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/SecurityAudit'
        - 'arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess'
      Policies:
        - PolicyName: 'SpotOptimizerCostExplorerRead'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ce:GetCostAndUsage'
                  - 'ce:GetCostForecast'
                  - 'ce:GetReservationUtilization'
                  - 'ce:GetDimensionValues'
                Resource: '*'

Outputs:
  RoleArn:
    Description: 'The ARN of the created IAM Role'
    Value: !GetAtt SpotOptimizerRole.Arn
